<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Cinética Química</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.2.1/lib/browser/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            display: flex;
            justify-content: space-between;
            max-width: 95%;
            margin: 0 auto;
        }
        .left-panel, .right-panel {
            background-color: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .left-panel {
            width: 35%;
        }
        .right-panel {
            width: 60%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        input, select, button {
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 20px);
        }
        input[type="checkbox"] {
            width: auto;
            margin-left: 0;
        }
        label {
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }
        .form-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .form-group label {
            flex: 1;
            margin-right: 10px;
        }
        .form-group input, .form-group select {
            flex: 2;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
            font-size: 16px;
            transition: background-color 0.3s ease;
            width: 32%; /* Ajustar el ancho de los botones */
        }
        button:hover {
            background-color: #0056b3;
        }
        canvas {
            width: 100%;
            height: 600px; /* Aumentar la altura de la gráfica */
        }
        sub {
            vertical-align: sub;
            font-size: smaller;
        }
        .advanced-settings {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Panel Izquierdo: Formulario -->
        <div class="left-panel">
            <h1>Simulador de Cinética Química</h1>

            <div class="form-group">
                <label for="numReactivos">Número de reactivos:</label>
                <input type="number" id="numReactivos" value="1" min="1" onchange="actualizarFormulario()">
            </div>

            <div id="reactivosForm"></div>

            <div class="form-group">
                <label for="k">Constante de velocidad (k):</label>
                <input type="number" id="k" value="0.6" step="0.01">
            </div>

            <div class="form-group">
                <label for="unidadVelocidad">Unidad de constante de velocidad:</label>
                <select id="unidadVelocidad">
                    <option value="s">1/segundos</option>
                    <option value="min">1/minutos</option>
                    <option value="h">1/horas</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tiempoFinal">Tiempo final (<i>t<sub>f</sub></i>):</label>
                <input type="number" id="tiempoFinal" value="10" step="1">
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="tiempoAutomatico">
                    Calcular automáticamente el tiempo de reacción
                </label>
            </div>

            <div class="form-group">
                <label for="unidadTiempo">Unidad de tiempo de reacción:</label>
                <select id="unidadTiempo">
                    <option value="s">segundos</option>
                    <option value="min">minutos</option>
                    <option value="h">horas</option>
                </select>
            </div>

            <div class="form-group">
                <label for="unidadConcentracion">Unidad de concentración:</label>
                <select id="unidadConcentracion">
                    <option value="M">Molar</option>
                    <option value="mM">mMolar</option>
                    <option value="uM">µMolar</option>
                </select>
            </div>

            <div class="form-group">
                <label for="reactivoBase">Especie para representar:</label>
                <select id="reactivoBase"></select>
            </div>

            <div class="form-group">
                <button onclick="simular()">Resolver y Representar</button>
                <button onclick="limpiar()">Borrar Resultado</button>
                <button onclick="descargarCSV()">Descargar CSV</button>
            </div>

            <div class="form-group">
                <label for="notacionDecimal">Notación decimal:</label>
                <select id="notacionDecimal">
                    <option value="punto">Punto decimal</option>
                    <option value="coma">Coma decimal</option>
                </select>
            </div>

            <details class="advanced-settings">
                <summary>Configuración avanzada</summary>
                <div class="form-group">
                    <label for="metodoIntegracion">Método numérico:</label>
                    <select id="metodoIntegracion">
                        <option value="rk4" selected>Runge-Kutta 4º orden</option>
                        <option value="euler">Euler hacia adelante</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="numPuntos">Puntos de cálculo:</label>
                    <input type="number" id="numPuntos" value="200" min="10" step="10">
                </div>
                <div class="form-group">
                    <label for="forzarNoNegativas">Forzar concentraciones no negativas:</label>
                    <input type="checkbox" id="forzarNoNegativas" checked>
                </div>
            </details>
        </div>

        <!-- Panel Derecho: Gráfica -->
        <div class="right-panel">
            <canvas id="grafica"></canvas>
        </div>
    </div>

    <script>
        let grafica;  // Variable para la gráfica
        let resultados = [];  // Almacenar resultados para CSV

        // Actualiza el formulario según el número de reactivos
        function actualizarFormulario() {
            const numReactivos = document.getElementById('numReactivos').value;
            const reactivosForm = document.getElementById('reactivosForm');
            const reactivoBaseSelect = document.getElementById('reactivoBase');
            reactivosForm.innerHTML = '';
            reactivoBaseSelect.innerHTML = '';

            for (let i = 0; i < numReactivos; i++) {
                reactivosForm.innerHTML += `
                    <div class="form-group">
                        <label>Orden del reactivo ${i + 1}:</label>
                        <input type="number" id="orden${i}" value="1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Concentración inicial [A<sub>${i + 1}</sub>]<sub>0</sub>:</label>
                        <input type="number" id="C0${i}" value="1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Coeficiente estequiométrico ν<sub>${i + 1}</sub>:</label>
                        <input type="number" id="stoich${i}" value="-1" step="0.1">
                    </div>
                `;
                reactivoBaseSelect.innerHTML += `<option value="${i}">Especie ${i + 1}</option>`;
            }
        }

        // Función para resolver las ecuaciones y graficar los resultados
        function simular() {
            const numReactivos = parseInt(document.getElementById('numReactivos').value, 10);
            const k = parseFloat(document.getElementById('k').value);
            const unidadVelocidad = document.getElementById('unidadVelocidad').value;
            const tiempoFinal = parseFloat(document.getElementById('tiempoFinal').value);
            const unidadTiempo = document.getElementById('unidadTiempo').value;
            const unidadConcentracion = document.getElementById('unidadConcentracion').value;
            const reactivoBase = parseInt(document.getElementById('reactivoBase').value);
            const metodoIntegracion = document.getElementById('metodoIntegracion').value;
            const numPuntos = parseInt(document.getElementById('numPuntos').value, 10);
            const forzarNoNegativas = document.getElementById('forzarNoNegativas').checked;
            const autoTiempo = document.getElementById('tiempoAutomatico').checked;

            if (isNaN(numPuntos) || numPuntos < 1) {
                alert('El número de puntos de cálculo debe ser un entero positivo.');
                return;
            }

            let ordenes = [];
            let concentracionesIniciales = [];
            let coeficientesEstequiometricos = [];

            for (let i = 0; i < numReactivos; i++) {
                const orden = parseFloat(document.getElementById(`orden${i}`).value);
                const concentracionInicial = parseFloat(document.getElementById(`C0${i}`).value);
                const coeficiente = parseFloat(document.getElementById(`stoich${i}`).value);

                if (isNaN(orden) || isNaN(concentracionInicial) || isNaN(coeficiente)) {
                    alert(`Todos los parámetros del reactivo ${i + 1} deben ser valores numéricos.`);
                    return;
                }

                ordenes.push(orden);
                concentracionesIniciales.push(concentracionInicial);
                coeficientesEstequiometricos.push(coeficiente);
            }

            // Conversión de unidades de la constante de velocidad
            let kConvertido = k;
            if (unidadVelocidad === 'min') {
                kConvertido = k / 60;  // Convertir de 1/minutos a 1/segundos
            } else if (unidadVelocidad === 'h') {
                kConvertido = k / 3600;  // Convertir de 1/horas a 1/segundos
            }

            if (!autoTiempo && (isNaN(tiempoFinal) || tiempoFinal <= 0)) {
                alert('El tiempo final debe ser un número positivo.');
                return;
            }

            // Conversión de tiempo de reacción a segundos
            let tiempoFinalSegundos = null;
            if (!autoTiempo) {
                tiempoFinalSegundos = tiempoFinal;
                if (unidadTiempo === 'min') {
                    tiempoFinalSegundos = tiempoFinal * 60;  // Convertir de minutos a segundos
                } else if (unidadTiempo === 'h') {
                    tiempoFinalSegundos = tiempoFinal * 3600;  // Convertir de horas a segundos
                }
            }

            // Resolver ecuaciones diferenciales para cada reactivo usando el método seleccionado
            const pasos = Math.max(numPuntos, 1);
            const dt = autoTiempo || tiempoFinalSegundos === null ? null : tiempoFinalSegundos / pasos;
            let tiempos = [];
            let concentraciones = [];

            const calcularDerivadas = (estado) => {
                const producto = estado.reduce((acc, C, idx) => acc * Math.pow(Math.max(C, 0), ordenes[idx]), 1);
                const velocidad = kConvertido * producto;
                return estado.map((_, idx) => coeficientesEstequiometricos[idx] * velocidad);
            };

            const aplicarForzado = (estado) => {
                if (!forzarNoNegativas) return estado;
                return estado.map(valor => Math.max(valor, 0));
            };

            let estadoActual = concentracionesIniciales.slice();
            let tiempoActual = 0;

            tiempos.push(tiempoActual);
            concentraciones.push(estadoActual.slice());

            if (autoTiempo) {
                const indicesReactivos = coeficientesEstequiometricos
                    .map((coef, idx) => ({ coef, idx }))
                    .filter(item => item.coef < 0);

                if (indicesReactivos.length === 0) {
                    alert('Debe definir al menos un reactivo con coeficiente estequiométrico negativo.');
                    return;
                }

                const tolerancia = 1e-8;
                const maxIteraciones = Math.max(pasos * 20, 1000);
                let iteracion = 0;
                let finalizadoAutomaticamente = false;

                while (iteracion < maxIteraciones) {
                    const derivadas = calcularDerivadas(estadoActual);

                    const tiemposHastaCero = indicesReactivos.map(({ idx }) => {
                        const derivada = derivadas[idx];
                        if (derivada >= 0) return Infinity;
                        const concentracion = Math.max(estadoActual[idx], 0);
                        return concentracion / Math.abs(derivada);
                    });

                    const minimoTiempoHastaCero = Math.min(...tiemposHastaCero);

                    if (!isFinite(minimoTiempoHastaCero) || minimoTiempoHastaCero === Infinity) {
                        // No hay consumo de reactivos, finaliza para evitar bucles infinitos
                        break;
                    }

                    if (minimoTiempoHastaCero <= tolerancia) {
                        finalizadoAutomaticamente = indicesReactivos.every(({ idx }) => Math.max(estadoActual[idx], 0) <= 1e-6);
                        tiempoFinalSegundos = tiempoActual;
                        break;
                    }

                    let pasoAdaptativo = Math.min(minimoTiempoHastaCero / 5, minimoTiempoHastaCero);
                    pasoAdaptativo = Math.max(pasoAdaptativo, tolerancia);

                    let siguienteEstado;
                    if (metodoIntegracion === 'euler') {
                        const k1 = derivadas;
                        siguienteEstado = estadoActual.map((c, idx) => c + k1[idx] * pasoAdaptativo);
                    } else {
                        const k1 = derivadas;
                        const k2 = calcularDerivadas(estadoActual.map((c, idx) => c + 0.5 * pasoAdaptativo * k1[idx]));
                        const k3 = calcularDerivadas(estadoActual.map((c, idx) => c + 0.5 * pasoAdaptativo * k2[idx]));
                        const k4 = calcularDerivadas(estadoActual.map((c, idx) => c + pasoAdaptativo * k3[idx]));
                        siguienteEstado = estadoActual.map((c, idx) => c + (pasoAdaptativo / 6) * (k1[idx] + 2 * k2[idx] + 2 * k3[idx] + k4[idx]));
                    }

                    siguienteEstado = aplicarForzado(siguienteEstado);
                    tiempoActual += pasoAdaptativo;

                    tiempos.push(tiempoActual);
                    concentraciones.push(siguienteEstado.slice());
                    estadoActual = siguienteEstado;
                    iteracion++;

                    const reaccionFinalizada = indicesReactivos.every(({ idx }) => Math.max(estadoActual[idx], 0) <= 1e-6);
                    if (reaccionFinalizada) {
                        tiempoFinalSegundos = tiempoActual;
                        finalizadoAutomaticamente = true;
                        break;
                    }
                }

                if (!finalizadoAutomaticamente) {
                    const reaccionYaCompletada = indicesReactivos.every(({ idx }) => Math.max(estadoActual[idx], 0) <= 1e-6);
                    if (!reaccionYaCompletada) {
                        alert('No fue posible determinar el tiempo de reacción automáticamente. Revise los parámetros de entrada.');
                        return;
                    }
                    tiempoFinalSegundos = tiempoActual;
                }

                if (tiempos.length > pasos + 1) {
                    const nuevoTiempos = [];
                    const nuevoConcentraciones = [];
                    const pasoMuestreo = (tiempos.length - 1) / pasos;

                    for (let i = 0; i <= pasos; i++) {
                        const indice = Math.min(Math.round(i * pasoMuestreo), tiempos.length - 1);
                        nuevoTiempos.push(tiempos[indice]);
                        nuevoConcentraciones.push(concentraciones[indice]);
                    }

                    tiempos = nuevoTiempos;
                    concentraciones = nuevoConcentraciones;
                }
            } else {
                for (let i = 0; i < pasos; i++) {
                    let siguienteEstado;

                    if (metodoIntegracion === 'euler') {
                        const k1 = calcularDerivadas(estadoActual);
                        siguienteEstado = estadoActual.map((c, idx) => c + k1[idx] * dt);
                    } else {
                        const k1 = calcularDerivadas(estadoActual);
                        const k2 = calcularDerivadas(estadoActual.map((c, idx) => c + 0.5 * dt * k1[idx]));
                        const k3 = calcularDerivadas(estadoActual.map((c, idx) => c + 0.5 * dt * k2[idx]));
                        const k4 = calcularDerivadas(estadoActual.map((c, idx) => c + dt * k3[idx]));
                        siguienteEstado = estadoActual.map((c, idx) => c + (dt / 6) * (k1[idx] + 2 * k2[idx] + 2 * k3[idx] + k4[idx]));
                    }

                    siguienteEstado = aplicarForzado(siguienteEstado);
                    tiempoActual += dt;

                    tiempos.push(tiempoActual);
                    concentraciones.push(siguienteEstado.slice());
                    estadoActual = siguienteEstado;
                }
            }

            // Extraer las concentraciones del reactivo seleccionado
            let concentracionReactivoBase = concentraciones.map(c => c[reactivoBase]);

            // Convertir el vector de tiempo de vuelta a la unidad seleccionada por el usuario
            let factorTiempo = 1;
            if (unidadTiempo === 'min') {
                factorTiempo = 60;
            } else if (unidadTiempo === 'h') {
                factorTiempo = 3600;
            }

            tiempos = tiempos.map(tiempo => tiempo / factorTiempo);

            if (autoTiempo) {
                const tiempoFinalConvertido = tiempoFinalSegundos / factorTiempo;
                if (!isNaN(tiempoFinalConvertido) && isFinite(tiempoFinalConvertido)) {
                    document.getElementById('tiempoFinal').value = tiempoFinalConvertido.toFixed(4);
                }
            }

            // Guardar los resultados para el CSV
            resultados = tiempos.map((tiempo, index) => [tiempo, ...concentraciones[index]]);

            // Graficar los resultados
            const ctx = document.getElementById('grafica').getContext('2d');
            if (grafica) grafica.destroy();  // Destruir la gráfica anterior si existe
            grafica = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: tiempos.map(time => time.toFixed(2)), // Redondear los valores de tiempo a 2 decimales
                    datasets: [{
                        label: `Concentración de la Especie ${reactivoBase + 1} (${unidadConcentracion})`,
                        data: concentracionReactivoBase,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false,
                    }]
                },
                options: {
                    scales: {
                        x: { 
                            title: { display: true, text: `Tiempo (${unidadTiempo})` }
                        },
                        y: { 
                            title: { display: true, text: `Concentración (${unidadConcentracion})` }
                        }
                    }
                }
            });
        }

        // Función para limpiar la gráfica y los resultados
        function limpiar() {
            if (grafica) grafica.destroy();  // Destruir la gráfica actual
            document.getElementById('grafica').getContext('2d').clearRect(0, 0, 400, 400);  // Limpiar el canvas
            resultados = [];  // Borrar los resultados
        }

        // Función para descargar los resultados como un archivo CSV
        function descargarCSV() {
            if (resultados.length === 0) {
                alert("No hay resultados para descargar.");
                return;
            }

            const notacion = document.getElementById("notacionDecimal").value;

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Tiempo;Concentraciones\n";  // Encabezado con punto y coma como separador

            resultados.forEach((fila) => {
                const filaFormateada = fila.map(num => {
                    let strNum = num.toFixed(4); // Convertir a cadena con 4 decimales
                    if (notacion === "coma") {
                        strNum = strNum.replace('.', ','); // Reemplazar punto por coma
                    }
                    return strNum;
                });
                csvContent += filaFormateada.join(";") + "\n";  // Agregar cada fila de datos usando punto y coma
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "resultados_cinetica.csv");
            document.body.appendChild(link);  // Necesario para hacer clic en el enlace
            link.click();  // Descargar el archivo
        }

        const checkboxTiempoAutomatico = document.getElementById('tiempoAutomatico');
        const manejarCambioTiempoAutomatico = (evento) => {
            document.getElementById('tiempoFinal').disabled = evento.target.checked;
        };

        checkboxTiempoAutomatico.addEventListener('change', manejarCambioTiempoAutomatico);

        // Inicializar el formulario
        actualizarFormulario();
        manejarCambioTiempoAutomatico({ target: checkboxTiempoAutomatico });
    </script>
</body>
</html>
